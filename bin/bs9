#!/usr/bin/env bun

import { Command } from "commander";
import { readFileSync } from "node:fs";
import { join, dirname } from "node:path";

// Read version from package.json
const packageJsonPath = join(dirname(import.meta.path), '..', 'package.json');
const packageJson = JSON.parse(readFileSync(packageJsonPath, 'utf8'));
const version = packageJson.version;

import { startCommand } from "../src/commands/start.js";
import { stopCommand } from "../src/commands/stop.js";
import { restartCommand } from "../src/commands/restart.js";
import { statusCommand } from "../src/commands/status.js";
import { logsCommand } from "../src/commands/logs.js";
import { monitCommand } from "../src/commands/monit.js";
import { webCommand } from "../src/commands/web.js";
import { alertCommand } from "../src/commands/alert.js";
import { exportCommand } from "../src/commands/export.js";
import { depsCommand } from "../src/commands/deps.js";
import { profileCommand } from "../src/commands/profile.js";
import { loadbalancerCommand } from "../src/loadbalancer/manager.js";
import { windowsCommand } from "../src/windows/service.js";
import { launchdCommand } from "../src/macos/launchd.js";
import { updateCommand } from "../src/commands/update.js";
import { dbpoolCommand } from "../src/database/pool.js";
import { advancedMonitoringCommand } from "../src/monitoring/advanced.js";
import { consulCommand } from "../src/discovery/consul.js";

const program = new Command();

program
  .name("bs9")
  .description("BS9 (Bun Sentinel 9) â€” Mission-critical process manager CLI")
  .version(version);

program
  .command("start")
  .description("Start a process with hardened systemd unit")
  .argument("<file>", "Application file to start")
  .option("-n, --name <name>", "Service name")
  .option("-p, --port <port>", "Port number", "3000")
  .option("-h, --host <host>", "Host address", "localhost")
  .option("--https", "Use HTTPS protocol")
  .option("-e, --env <env>", "Environment variables (can be used multiple times)", (value, previous) => [...(previous || []), value])
  .option("--otel", "Enable OpenTelemetry instrumentation", true)
  .option("--prometheus", "Enable Prometheus metrics", true)
  .option("--build", "Build TypeScript to JavaScript before starting")
  .action(startCommand);

program
  .command("stop")
  .description("Stop a managed service")
  .argument("<name>", "Service name")
  .action(stopCommand);

program
  .command("restart")
  .description("Restart a managed service")
  .argument("<name>", "Service name")
  .action(restartCommand);

program
  .command("status")
  .description("Show status and SRE metrics for all services")
  .option("-w, --watch", "Watch mode (refresh every 2s)")
  .action(statusCommand);

program
  .command("logs")
  .description("Show logs for a service (via journalctl)")
  .argument("<name>", "Service name")
  .option("-f, --follow", "Follow logs")
  .option("-n, --lines <number>", "Number of lines", "50")
  .action(logsCommand);

program
  .command("monit")
  .description("Real-time terminal dashboard for all services")
  .option("-r, --refresh <seconds>", "Refresh interval in seconds", "2")
  .action(monitCommand);

program
  .command("web")
  .description("Start web-based monitoring dashboard")
  .option("-p, --port <port>", "Port for web dashboard", "8080")
  .option("-d, --detach", "Run in background")
  .action(webCommand);

program
  .command("alert")
  .description("Configure alert thresholds and webhooks")
  .option("--enable", "Enable alerts")
  .option("--disable", "Disable alerts")
  .option("--webhook <url>", "Set webhook URL for alerts")
  .option("--cpu <percentage>", "CPU threshold percentage")
  .option("--memory <percentage>", "Memory threshold percentage")
  .option("--errorRate <percentage>", "Error rate threshold percentage")
  .option("--uptime <percentage>", "Uptime threshold percentage")
  .option("--cooldown <seconds>", "Alert cooldown period in seconds")
  .option("--service <name>", "Configure alerts for specific service")
  .option("--list", "List current alert configuration")
  .option("--test", "Test webhook connectivity")
  .action(alertCommand);

program
  .command("export")
  .description("Export historical metrics data")
  .option("-f, --format <format>", "Export format (json|csv)", "json")
  .option("-h, --hours <hours>", "Hours of data to export", "24")
  .option("-o, --output <file>", "Output file path")
  .option("-s, --service <name>", "Export specific service metrics")
  .action(exportCommand);

program
  .command("deps")
  .description("Visualize service dependencies")
  .option("-f, --format <format>", "Output format (text|dot|json)", "text")
  .option("-o, --output <file>", "Output file path")
  .action(depsCommand);

program
  .command("profile")
  .description("Performance profiling for services")
  .option("-d, --duration <seconds>", "Profiling duration", "60")
  .option("-i, --interval <ms>", "Sampling interval", "1000")
  .option("-s, --service <name>", "Service name to profile")
  .option("-o, --output <file>", "Output file path")
  .action(profileCommand);

program
  .command("loadbalancer")
  .description("Load balancer management")
  .argument("<action>", "Action to perform")
  .option("-p, --port <port>", "Load balancer port", "8080")
  .option("-a, --algorithm <type>", "Load balancing algorithm", "round-robin")
  .option("-b, --backends <list>", "Backend servers (host:port,host:port)")
  .option("--health-check", "Enable health checking", true)
  .option("--health-path <path>", "Health check path", "/healthz")
  .option("--health-interval <ms>", "Health check interval", "10000")
  .action(loadbalancerCommand);

program
  .command("dbpool")
  .description("Database connection pool management")
  .argument("<action>", "Action to perform")
  .option("--host <host>", "Database host", "localhost")
  .option("--port <port>", "Database port", "5432")
  .option("--database <name>", "Database name", "testdb")
  .option("--username <user>", "Database username", "user")
  .option("--password <pass>", "Database password", "password")
  .option("--max-connections <num>", "Maximum connections", "10")
  .option("--min-connections <num>", "Minimum connections", "2")
  .option("--concurrency <num>", "Test concurrency", "10")
  .option("--iterations <num>", "Test iterations", "100")
  .action(dbpoolCommand);

program
  .command("update")
  .description("Update BS9 to latest version")
  .option("--check", "Check for updates without installing")
  .option("--force", "Force update even if already latest")
  .option("--rollback", "Rollback to previous version")
  .option("--version <version>", "Update to specific version")
  .action(updateCommand);

program
  .command("advanced")
  .description("Advanced monitoring dashboard")
  .option("--port <port>", "Dashboard port", "8090")
  .action(advancedMonitoringCommand);

program
  .command("consul")
  .description("Consul service discovery")
  .argument("<action>", "Action to perform")
  .option("--consul-url <url>", "Consul URL", "http://localhost:8500")
  .option("--name <name>", "Service name")
  .option("--id <id>", "Service ID")
  .option("--address <address>", "Service address")
  .option("--port <port>", "Service port")
  .option("--tags <tags>", "Service tags (comma-separated)")
  .option("--health-check <url>", "Health check URL")
  .option("--meta <json>", "Service metadata (JSON)")
  .option("--service <service>", "Service name for discovery")
  .action(consulCommand);

program.parse();
